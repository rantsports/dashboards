<!DOCTYPE html>
<html lang="ru" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-First Progress Dashboard | По спринтам</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 350px;
        }
        .filter-chip {
            transition: all 0.2s ease;
        }
        .filter-chip.active {
            background-color: #3b82f6;
            color: white;
        }
        .filter-chip:hover {
            transform: translateY(-1px);
        }
        .dark canvas {
            filter: none;
        }
        .metric-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 transition-colors">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">AI-First Progress Dashboard</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Измерение внедрения AI-First по отделам</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Theme Toggle -->
                    <button id="themeToggle" onclick="toggleTheme()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Переключить тему">
                        <svg id="sunIcon" class="w-5 h-5 text-gray-600 dark:text-gray-300 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg id="moonIcon" class="w-5 h-5 text-gray-600 dark:text-gray-300 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    <div class="text-right text-sm text-gray-500 dark:text-gray-400">
                        <p>Последнее обновление данных:</p>
                        <p class="font-medium" id="lastUpdate">31 января 2026</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 sticky top-0 z-10 transition-colors">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- Department Filter -->
                <div class="flex-1 min-w-[300px]">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Отделы</label>
                    <div id="deptFilters" class="flex flex-wrap gap-1">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <!-- Sprint Range Filter -->
                <div class="min-w-[300px]">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Диапазон спринтов</label>
                    <div class="flex items-center gap-2">
                        <select id="sprintFrom" class="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1 text-sm">
                            <!-- Generated by JS -->
                        </select>
                        <span class="text-gray-400">—</span>
                        <select id="sprintTo" class="border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1 text-sm">
                            <!-- Generated by JS -->
                        </select>
                    </div>
                </div>
                
                <!-- Reset Button -->
                <button onclick="resetFilters()" class="px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 dark:text-white rounded transition">
                    Сбросить
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards - Key Metrics -->
    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Metric 1: AI Roles in Prod -->
            <div class="metric-card bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors border-l-4 border-blue-500">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">AI-ролей в проде</p>
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="totalAiRoles">-</p>
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">с владельцем и KPI</p>
            </div>
            <!-- Metric 2: AI Functions -->
            <div class="metric-card bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors border-l-4 border-cyan-500">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">AI-функции</p>
                <p class="text-2xl font-bold text-cyan-600 dark:text-cyan-400" id="totalAiFunctions">-</p>
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">автоматизировано / всего</p>
            </div>
            <!-- Metric 3: Data Sources Coverage -->
            <div class="metric-card bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors border-l-4 border-indigo-500">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Накопление данных</p>
                <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="dataSourcesCoverage">-</p>
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">источников в shared-workspace / всего</p>
            </div>
            <!-- Metric 4: Active Users -->
            <div class="metric-card bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors border-l-4 border-emerald-500">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Активные пользователи</p>
                <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400" id="activeUsers">50</p>
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">в Cursor</p>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Chart 1: AI Roles by Sprint (Stacked Bar) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">AI-роли в проде по спринтам</h3>
                <div class="chart-container">
                    <canvas id="aiRolesChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: AI Roles by Department (Horizontal Bar) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">AI-роли в проде по отделам</h3>
                <div class="chart-container">
                    <canvas id="deptComparisonChart"></canvas>
                </div>
            </div>

            <!-- AI Roles List (Tree View) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
                    Список AI-ролей <span id="rolesCount" class="text-sm font-normal text-gray-500 dark:text-gray-400"></span>
                </h3>
                <div class="overflow-y-auto max-h-[350px]" id="rolesListContainer">
                    <div id="rolesList" class="text-sm text-gray-700 dark:text-gray-300">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Chart 3: AI Functions Progress -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">AI-функции: прогресс автоматизации</h3>
                <div class="chart-container">
                    <canvas id="aiFunctionsChart"></canvas>
                </div>
            </div>

            <!-- Functions List (Tree View) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
                    Список AI-функций <span id="functionsCount" class="text-sm font-normal text-gray-500 dark:text-gray-400"></span>
                </h3>
                <div class="overflow-y-auto max-h-[350px]" id="functionsListContainer">
                    <div id="functionsList" class="text-sm text-gray-700 dark:text-gray-300">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Chart 4: Data Sources Coverage Progress -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Накопление данных: прогресс покрытия источников</h3>
                <div class="chart-container">
                    <canvas id="dataSourcesChart"></canvas>
                </div>
            </div>

            <!-- Data Sources List (Tree View) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
                    Список источников данных <span id="sourcesCount" class="text-sm font-normal text-gray-500 dark:text-gray-400"></span>
                </h3>
                <div class="overflow-y-auto max-h-[350px]" id="dataSourcesListContainer">
                    <div id="dataSourcesList" class="text-sm text-gray-700 dark:text-gray-300">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Chart 5: Efficiency Placeholder -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-900 p-4 transition-colors lg:col-span-2">
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Изменение эффективности работы</h3>
                <div class="chart-container flex items-center justify-center">
                    <div class="text-center p-8">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p class="text-gray-500 dark:text-gray-400 text-lg max-w-md">
                            Здесь будет график, показывающий изменение эффективности работы, но мы ещё в процессе понимания как корректно эту метрику снимать.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-500 dark:text-gray-400">
        <p>AI-First Progress Dashboard | Rantsports</p>
    </footer>

    <script>
        // ============================================
        // EMBEDDED DATA - PLACEHOLDER FOR DEMO
        // ============================================
        // ============================================
        // AI ROLES LIST
        // ============================================
        const AI_ROLES = [
            // Analytics
            { id: 'r1', name: 'AI-аналитик', department: 'Analytics', inProdSince: '2026-S01' },
        ];

        // ============================================
        // AI FUNCTIONS LIST
        // ============================================
        const AI_FUNCTIONS = [
            // Analytics
            { id: 'f1', name: 'AI-дашборд внедрения', department: 'Analytics', automatedSince: '2026-S01' },
            { id: 'f2', name: 'Автоматический отчёт по метрикам', department: 'Analytics', automatedSince: null },
            { id: 'f3', name: 'Прогнозирование KPI', department: 'Analytics', automatedSince: null },
            // Technology
            { id: 'f4', name: 'AI Code Review', department: 'Technology', automatedSince: null },
            { id: 'f5', name: 'Автогенерация тестов', department: 'Technology', automatedSince: null },
            { id: 'f6', name: 'AI-документация кода', department: 'Technology', automatedSince: null },
            // Marketing
            { id: 'f7', name: 'Генерация контента для соцсетей', department: 'Marketing', automatedSince: null },
            { id: 'f8', name: 'AI-копирайтинг', department: 'Marketing', automatedSince: null },
            { id: 'f9', name: 'Анализ конкурентов', department: 'Marketing', automatedSince: null },
            // Sales
            { id: 'f10', name: 'AI-скоринг лидов', department: 'Sales', automatedSince: null },
            { id: 'f11', name: 'Автоматизация follow-up', department: 'Sales', automatedSince: null },
            // HR
            { id: 'f12', name: 'AI-скрининг резюме', department: 'HR', automatedSince: null },
            { id: 'f13', name: 'Автоматизация онбординга', department: 'HR', automatedSince: null },
            // Project Office
            { id: 'f14', name: 'AI-планирование спринтов', department: 'Project Office', automatedSince: null },
            { id: 'f15', name: 'Автоматические отчёты по проектам', department: 'Project Office', automatedSince: null },
            // Monetization
            { id: 'f16', name: 'AI-оптимизация цен', department: 'Monetization', automatedSince: null },
            { id: 'f17', name: 'Прогнозирование выручки', department: 'Monetization', automatedSince: null },
            // SEO
            { id: 'f18', name: 'AI-анализ ключевых слов', department: 'SEO', automatedSince: null },
            { id: 'f19', name: 'Автогенерация мета-тегов', department: 'SEO', automatedSince: null },
            // Media
            { id: 'f20', name: 'AI-редактирование видео', department: 'Media', automatedSince: null },
            { id: 'f21', name: 'Автогенерация превью', department: 'Media', automatedSince: null },
            // Sport Fan Engagement
            { id: 'f24', name: 'Персонализация контента', department: 'Sport Fan Engagement', automatedSince: null },
            { id: 'f25', name: 'AI-рекомендации матчей', department: 'Sport Fan Engagement', automatedSince: null },
            // Back Office
            { id: 'f26', name: 'Автоматизация документооборота', department: 'Back Office', automatedSince: null },
            { id: 'f27', name: 'AI-обработка счетов', department: 'Back Office', automatedSince: null }
        ];

        // ============================================
        // DATA SOURCES LIST
        // ============================================
        const DATA_SOURCES = [
            // Analytics
            { id: 's1', name: 'Google Analytics', department: 'Analytics', inWorkspaceSince: null },
            { id: 's2', name: 'Metabase', department: 'Analytics', inWorkspaceSince: null },
            { id: 's3', name: 'BI-отчёты', department: 'Analytics', inWorkspaceSince: null },
            // Technology
            { id: 's4', name: 'GitLab metrics', department: 'Technology', inWorkspaceSince: null },
            { id: 's5', name: 'Sentry errors', department: 'Technology', inWorkspaceSince: null },
            { id: 's6', name: 'CI/CD logs', department: 'Technology', inWorkspaceSince: null },
            { id: 's28', name: 'YouTrack', department: 'Technology', inWorkspaceSince: null },
            // Marketing
            { id: 's7', name: 'Social media stats', department: 'Marketing', inWorkspaceSince: null },
            { id: 's8', name: 'Email campaigns', department: 'Marketing', inWorkspaceSince: null },
            { id: 's9', name: 'Ad performance', department: 'Marketing', inWorkspaceSince: null },
            // Sales
            { id: 's10', name: 'CRM данные', department: 'Sales', inWorkspaceSince: null },
            { id: 's11', name: 'Pipeline отчёты', department: 'Sales', inWorkspaceSince: null },
            // HR
            { id: 's12', name: 'HRIS данные', department: 'HR', inWorkspaceSince: null },
            { id: 's13', name: 'Опросы сотрудников', department: 'HR', inWorkspaceSince: null },
            // Project Office
            { id: 's29', name: 'Google Meet', department: 'Project Office', inWorkspaceSince: null },
            { id: 's30', name: 'Google Calendar', department: 'Project Office', inWorkspaceSince: null },
            { id: 's31', name: 'Google Drive', department: 'Project Office', inWorkspaceSince: null },
            // Monetization
            { id: 's16', name: 'Revenue данные', department: 'Monetization', inWorkspaceSince: null },
            { id: 's17', name: 'Подписки', department: 'Monetization', inWorkspaceSince: null },
            // SEO
            { id: 's18', name: 'Search Console', department: 'SEO', inWorkspaceSince: null },
            { id: 's19', name: 'Ahrefs/SEMrush', department: 'SEO', inWorkspaceSince: null },
            // Media
            { id: 's20', name: 'YouTube Analytics', department: 'Media', inWorkspaceSince: null },
            { id: 's21', name: 'DAM система', department: 'Media', inWorkspaceSince: null },
            // Sport Fan Engagement
            { id: 's24', name: 'Fan activity', department: 'Sport Fan Engagement', inWorkspaceSince: null },
            { id: 's25', name: 'Match data API', department: 'Sport Fan Engagement', inWorkspaceSince: null },
            // Back Office
            { id: 's26', name: 'Бухгалтерия', department: 'Back Office', inWorkspaceSince: null },
            { id: 's27', name: 'Юридические документы', department: 'Back Office', inWorkspaceSince: null }
        ];

        const RAW_DATA = [
            // 2026 Sprint 01
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Analytics","aiRolesInProd":1,"aiFunctionsAutomated":1,"aiFunctionsTotal":25,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":20,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Technology","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":40,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":25,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Marketing","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":22,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":18,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Sales","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":18,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":15,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"HR","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":15,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":12,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Project Office","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":20,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":14,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Back Office","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":16,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":12,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Monetization","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":16,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":10,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"SEO","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":14,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":12,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Media","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":12,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":10,"decisionSpeedDays":0},
            {"sprintId":"2026-S01","sprintLabel":"2026 Sprint 01","department":"Sport Fan Engagement","aiRolesInProd":0,"aiFunctionsAutomated":0,"aiFunctionsTotal":20,"aiFirstWorkPercent":0,"automationCoverage":0,"hoursSaved":0,"dataSourcesInWorkspace":0,"dataSourcesTotal":15,"decisionSpeedDays":0}
        ];

        // ============================================
        // CONSTANTS & STATE
        // ============================================
        const DEPT_COLORS = {
            'Technology': '#3b82f6',            // blue
            'Analytics': '#22c55e',             // green (same as Monetization in ref)
            'Marketing': '#ec4899',             // pink
            'Sales': '#f97316',                 // orange (same as B2B in ref)
            'HR': '#6366f1',                    // indigo
            'Project Office': '#0ea5e9',        // sky blue
            'Monetization': '#22c55e',          // green (same as ref)
            'SEO': '#eab308',                   // yellow (same as ref)
            'Media': '#f43f5e',                 // rose
            'Back Office': '#78716c',           // stone
            'Sport Fan Engagement': '#8b5cf6'   // purple (same as ref)
        };

        const DEPT_SHORT_NAMES = {
            'Technology': 'Technology',
            'Analytics': 'Analytics',
            'Marketing': 'Marketing',
            'Sales': 'Sales',
            'HR': 'HR',
            'Project Office': 'Project Office',
            'Monetization': 'Monetization',
            'SEO': 'SEO',
            'Media': 'Media',
            'Back Office': 'Back Office',
            'Sport Fan Engagement': 'Sport Fan Engagement'
        };

        let allSprints = [];
        let selectedDepts = new Set();
        let selectedSprintFrom = null;
        let selectedSprintTo = null;
        let charts = {};

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getUniqueSprints() {
            const sprintMap = new Map();
            RAW_DATA.forEach(d => {
                if (!sprintMap.has(d.sprintId)) {
                    sprintMap.set(d.sprintId, d.sprintLabel);
                }
            });
            return [...sprintMap.entries()]
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([id, label]) => ({ id, label }));
        }

        function getUniqueDepts() {
            const depts = new Set();
            RAW_DATA.forEach(d => depts.add(d.department));
            return [...depts].sort();
        }

        function getFilteredData() {
            return RAW_DATA.filter(d => {
                const inDept = selectedDepts.has(d.department);
                const inRange = d.sprintId >= selectedSprintFrom && d.sprintId <= selectedSprintTo;
                return inDept && inRange;
            });
        }

        function getFilteredSprints() {
            return allSprints.filter(s => s.id >= selectedSprintFrom && s.id <= selectedSprintTo);
        }

        function formatPercent(value) {
            return (value * 100).toFixed(1) + '%';
        }

        function getDeptName(dept) {
            return DEPT_SHORT_NAMES[dept] || dept;
        }

        function median(arr) {
            if (arr.length === 0) return 0;
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // ============================================
        // FILTER FUNCTIONS
        // ============================================
        function initFilters() {
            allSprints = getUniqueSprints();
            const allDepts = getUniqueDepts();
            
            // Initialize selected departments
            selectedDepts = new Set(allDepts);
            
            if (allSprints.length > 0) {
                const lastIndex = allSprints.length - 1;
                const startIndex = Math.max(0, lastIndex - 5); // Last 6 sprints
                selectedSprintFrom = allSprints[startIndex].id;
                selectedSprintTo = allSprints[lastIndex].id;
            }

            // Department filters
            const deptFiltersEl = document.getElementById('deptFilters');
            
            // Add "All" button
            const allBtn = document.createElement('button');
            allBtn.id = 'allDeptsBtn';
            allBtn.className = 'filter-chip px-2 py-1 text-xs rounded border bg-blue-500 text-white';
            allBtn.textContent = 'Все';
            allBtn.onclick = () => {
                selectedDepts = new Set(allDepts);
                updateDeptFilterUI();
                updateDashboard();
            };
            deptFiltersEl.appendChild(allBtn);

            allDepts.forEach(dept => {
                const btn = document.createElement('button');
                btn.className = 'filter-chip px-2 py-1 text-xs rounded border';
                btn.textContent = getDeptName(dept);
                btn.style.borderColor = DEPT_COLORS[dept] || '#9ca3af';
                btn.dataset.dept = dept;
                btn.onclick = () => selectDept(dept);
                deptFiltersEl.appendChild(btn);
            });

            updateDeptFilterUI();

            // Sprint range filters
            const sprintFrom = document.getElementById('sprintFrom');
            const sprintTo = document.getElementById('sprintTo');
            
            allSprints.forEach(sprint => {
                const optionFrom = document.createElement('option');
                optionFrom.value = sprint.id;
                optionFrom.textContent = sprint.label;
                sprintFrom.appendChild(optionFrom);

                const optionTo = document.createElement('option');
                optionTo.value = sprint.id;
                optionTo.textContent = sprint.label;
                sprintTo.appendChild(optionTo);
            });

            sprintFrom.value = selectedSprintFrom;
            sprintTo.value = selectedSprintTo;

            sprintFrom.onchange = () => {
                selectedSprintFrom = sprintFrom.value;
                if (selectedSprintFrom > selectedSprintTo) {
                    selectedSprintTo = selectedSprintFrom;
                    sprintTo.value = selectedSprintTo;
                }
                updateDashboard();
            };

            sprintTo.onchange = () => {
                selectedSprintTo = sprintTo.value;
                if (selectedSprintTo < selectedSprintFrom) {
                    selectedSprintFrom = selectedSprintTo;
                    sprintFrom.value = selectedSprintFrom;
                }
                updateDashboard();
            };
        }

        function selectDept(dept) {
            // Select only this one department
            selectedDepts = new Set([dept]);
            updateDeptFilterUI();
            updateDashboard();
        }

        function updateDeptFilterUI() {
            const allDepts = getUniqueDepts();
            const allSelected = selectedDepts.size === allDepts.length;
            const isDark = isDarkMode();
            
            const allBtn = document.getElementById('allDeptsBtn');
            if (allSelected) {
                allBtn.className = 'filter-chip px-2 py-1 text-xs rounded border bg-blue-500 text-white';
            } else {
                allBtn.className = 'filter-chip px-2 py-1 text-xs rounded border bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300';
            }
            
            const buttons = document.querySelectorAll('#deptFilters button[data-dept]');
            buttons.forEach(btn => {
                const dept = btn.dataset.dept;
                if (selectedDepts.has(dept)) {
                    btn.style.backgroundColor = DEPT_COLORS[dept] || '#9ca3af';
                    btn.style.color = 'white';
                } else {
                    btn.style.backgroundColor = isDark ? '#374151' : '#f3f4f6';
                    btn.style.color = isDark ? '#e5e7eb' : '#374151';
                }
            });
        }

        function resetFilters() {
            const allDepts = getUniqueDepts();
            selectedDepts = new Set(allDepts);
            if (allSprints.length > 0) {
                const lastIndex = allSprints.length - 1;
                const startIndex = Math.max(0, lastIndex - 5);
                selectedSprintFrom = allSprints[startIndex].id;
                selectedSprintTo = allSprints[lastIndex].id;
            }
            document.getElementById('sprintFrom').value = selectedSprintFrom;
            document.getElementById('sprintTo').value = selectedSprintTo;
            updateDeptFilterUI();
            updateDashboard();
        }

        // ============================================
        // CHART FUNCTIONS
        // ============================================
        function createAiRolesChart() {
            const ctx = document.getElementById('aiRolesChart').getContext('2d');
            const sprints = getFilteredSprints();
            const depts = [...selectedDepts];

            // Use AI_ROLES array as single source of truth
            const datasets = depts.map(dept => ({
                label: getDeptName(dept),
                data: sprints.map(sprint => {
                    // Count roles in prod by this sprint for this department
                    return AI_ROLES.filter(r => 
                        r.department === dept && 
                        r.inProdSince && 
                        r.inProdSince <= sprint.id
                    ).length;
                }),
                backgroundColor: DEPT_COLORS[dept] || '#9ca3af',
                borderRadius: 4
            }));

            if (charts.aiRoles) charts.aiRoles.destroy();

            const colors = getChartColors();
            charts.aiRoles = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sprints.map(s => s.label.replace(/^\d{4}\s+/, '')),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, color: colors.textColor } },
                        tooltip: {
                            callbacks: {
                                afterLabel: (context) => {
                                    const dept = depts[context.datasetIndex];
                                    const sprint = sprints[context.dataIndex];
                                    // Get AI roles for this department that are in prod by this sprint
                                    const deptRoles = AI_ROLES.filter(r => 
                                        r.department === dept && 
                                        r.inProdSince && 
                                        r.inProdSince <= sprint.id
                                    );
                                    
                                    if (deptRoles.length > 0) {
                                        return deptRoles.map(r => `  • ${r.name}`);
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: '# AI-ролей', color: colors.textColor }, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
                    }
                }
            });
        }

        function createDeptComparisonChart() {
            const ctx = document.getElementById('deptComparisonChart').getContext('2d');
            const depts = [...selectedDepts];
            const currentSprint = selectedSprintTo;

            // Use AI_ROLES array as single source of truth
            const deptStats = depts.map(dept => {
                const aiRoles = AI_ROLES.filter(r => 
                    r.department === dept && 
                    r.inProdSince && 
                    r.inProdSince <= currentSprint
                ).length;
                return { dept, aiRoles };
            }).sort((a, b) => b.aiRoles - a.aiRoles);

            if (charts.deptComparison) charts.deptComparison.destroy();

            const colors = getChartColors();
            charts.deptComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deptStats.map(d => getDeptName(d.dept)),
                    datasets: [{
                        label: 'AI-ролей в проде',
                        data: deptStats.map(d => d.aiRoles),
                        backgroundColor: deptStats.map(d => DEPT_COLORS[d.dept] || '#9ca3af'),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    const stat = deptStats[context[0].dataIndex];
                                    return stat.dept;
                                },
                                afterLabel: (context) => {
                                    const stat = deptStats[context.dataIndex];
                                    const currentSprint = selectedSprintTo;
                                    // Get AI roles for this department that are in prod by current sprint
                                    const deptRoles = AI_ROLES.filter(r => 
                                        r.department === stat.dept && 
                                        r.inProdSince && 
                                        r.inProdSince <= currentSprint
                                    );
                                    
                                    const lines = [];
                                    if (deptRoles.length > 0) {
                                        lines.push('');
                                        lines.push('AI-роли:');
                                        deptRoles.forEach(r => {
                                            lines.push(`  • ${r.name}`);
                                        });
                                    }
                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        y: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
                    }
                }
            });
        }

        function createAiFunctionsChart() {
            const ctx = document.getElementById('aiFunctionsChart').getContext('2d');
            const sprints = getFilteredSprints();
            
            // Use AI_FUNCTIONS array as single source of truth
            const filteredFunctions = AI_FUNCTIONS.filter(f => selectedDepts.has(f.department));
            const total = filteredFunctions.length;

            // Aggregate by sprint - count automated functions at each sprint point
            const sprintData = sprints.map(sprint => {
                const automated = filteredFunctions.filter(f => f.automatedSince && f.automatedSince <= sprint.id).length;
                const coveragePercent = total > 0 ? (automated / total) * 100 : 0;
                return { automated, total, coveragePercent };
            });

            if (charts.aiFunctions) charts.aiFunctions.destroy();

            const colors = getChartColors();
            charts.aiFunctions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sprints.map(s => s.label.replace(/^\d{4}\s+/, '')),
                    datasets: [
                        {
                            label: 'Автоматизировано',
                            data: sprintData.map(d => d.automated),
                            backgroundColor: 'rgba(6, 182, 212, 0.8)',
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Всего функций',
                            data: sprintData.map(d => d.total),
                            backgroundColor: 'rgba(156, 163, 175, 0.4)',
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: '% автоматизации',
                            data: sprintData.map(d => d.coveragePercent),
                            type: 'line',
                            borderColor: '#22c55e',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, color: colors.textColor } },
                        tooltip: {
                            callbacks: {
                                afterBody: (context) => {
                                    const idx = context[0].dataIndex;
                                    const d = sprintData[idx];
                                    return `Прогресс: ${d.automated}/${d.total} (${d.coveragePercent.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
                        y: { 
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: '# функций', color: colors.textColor },
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: '% автоматизации', color: colors.textColor },
                            ticks: { callback: value => value + '%', color: colors.textColor },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function createDataSourcesChart() {
            const ctx = document.getElementById('dataSourcesChart').getContext('2d');
            const sprints = getFilteredSprints();
            
            // Use DATA_SOURCES array as single source of truth
            const filteredSources = DATA_SOURCES.filter(s => selectedDepts.has(s.department));
            const total = filteredSources.length;

            // Aggregate by sprint - count sources in workspace at each sprint point
            const sprintData = sprints.map(sprint => {
                const inWorkspace = filteredSources.filter(s => s.inWorkspaceSince && s.inWorkspaceSince <= sprint.id).length;
                const coveragePercent = total > 0 ? (inWorkspace / total) * 100 : 0;
                return { inWorkspace, total, coveragePercent };
            });

            if (charts.dataSources) charts.dataSources.destroy();

            const colors = getChartColors();
            charts.dataSources = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sprints.map(s => s.label.replace(/^\d{4}\s+/, '')),
                    datasets: [
                        {
                            label: 'В shared-workspace',
                            data: sprintData.map(d => d.inWorkspace),
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Всего источников',
                            data: sprintData.map(d => d.total),
                            backgroundColor: 'rgba(156, 163, 175, 0.4)',
                            borderRadius: 4,
                            yAxisID: 'y'
                        },
                        {
                            label: '% покрытия',
                            data: sprintData.map(d => d.coveragePercent),
                            type: 'line',
                            borderColor: '#22c55e',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, color: colors.textColor } },
                        tooltip: {
                            callbacks: {
                                afterBody: (context) => {
                                    const idx = context[0].dataIndex;
                                    const d = sprintData[idx];
                                    return `Покрытие: ${d.inWorkspace}/${d.total} (${d.coveragePercent.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
                        y: { 
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: '# источников', color: colors.textColor },
                            ticks: { color: colors.textColor },
                            grid: { color: colors.gridColor }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: '% покрытия', color: colors.textColor },
                            ticks: { callback: value => value + '%', color: colors.textColor },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // ============================================
        // LIST FUNCTIONS (Tree View)
        // ============================================
        function updateRolesList() {
            const container = document.getElementById('rolesList');
            const filteredRoles = AI_ROLES.filter(r => selectedDepts.has(r.department));
            const currentSprint = selectedSprintTo;
            
            // Group by department
            const byDept = {};
            filteredRoles.forEach(r => {
                if (!byDept[r.department]) byDept[r.department] = [];
                byDept[r.department].push(r);
            });
            
            // Count totals
            let totalInProd = 0;
            let totalRoles = filteredRoles.length;
            filteredRoles.forEach(r => {
                if (r.inProdSince && r.inProdSince <= currentSprint) totalInProd++;
            });
            
            // Update count in header
            document.getElementById('rolesCount').textContent = `(${totalInProd}/${totalRoles})`;
            
            // Render tree
            const depts = Object.keys(byDept).sort();
            container.innerHTML = depts.map(dept => {
                const roles = byDept[dept];
                const deptInProd = roles.filter(r => r.inProdSince && r.inProdSince <= currentSprint).length;
                const deptColor = DEPT_COLORS[dept] || '#9ca3af';
                
                return `
                <div class="mb-3">
                    <div class="flex items-center gap-2 py-1 px-2 rounded" style="background-color: ${deptColor}15">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${deptColor}"></span>
                        <span class="font-medium" style="color: ${deptColor}">${getDeptName(dept)}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">(${deptInProd}/${roles.length})</span>
                    </div>
                    <div class="ml-5 mt-1 space-y-1">
                        ${roles.map(r => {
                            const inProd = r.inProdSince && r.inProdSince <= currentSprint;
                            const sprintLabel = r.inProdSince ? `Sprint ${r.inProdSince.split('-')[1]}` : '';
                            return `
                            <div class="flex items-center justify-between py-1 px-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                                <span class="flex items-center gap-2">
                                    <span class="text-gray-400">${inProd ? '✓' : '○'}</span>
                                    <span>${r.name}</span>
                                </span>
                                ${inProd 
                                    ? `<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">${sprintLabel}</span>`
                                    : '<span class="text-xs text-gray-400">В планах</span>'
                                }
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        }

        function updateFunctionsList() {
            const container = document.getElementById('functionsList');
            const filteredFunctions = AI_FUNCTIONS.filter(f => selectedDepts.has(f.department));
            const currentSprint = selectedSprintTo;
            
            // Group by department
            const byDept = {};
            filteredFunctions.forEach(f => {
                if (!byDept[f.department]) byDept[f.department] = [];
                byDept[f.department].push(f);
            });
            
            // Count totals
            let totalAutomated = 0;
            let totalFunctions = filteredFunctions.length;
            filteredFunctions.forEach(f => {
                if (f.automatedSince && f.automatedSince <= currentSprint) totalAutomated++;
            });
            
            // Update count in header
            document.getElementById('functionsCount').textContent = `(${totalAutomated}/${totalFunctions})`;
            
            // Render tree
            const depts = Object.keys(byDept).sort();
            container.innerHTML = depts.map(dept => {
                const functions = byDept[dept];
                const deptAutomated = functions.filter(f => f.automatedSince && f.automatedSince <= currentSprint).length;
                const deptColor = DEPT_COLORS[dept] || '#9ca3af';
                
                return `
                <div class="mb-3">
                    <div class="flex items-center gap-2 py-1 px-2 rounded" style="background-color: ${deptColor}15">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${deptColor}"></span>
                        <span class="font-medium" style="color: ${deptColor}">${getDeptName(dept)}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">(${deptAutomated}/${functions.length})</span>
                    </div>
                    <div class="ml-5 mt-1 space-y-1">
                        ${functions.map(f => {
                            const isAutomated = f.automatedSince && f.automatedSince <= currentSprint;
                            const sprintLabel = f.automatedSince ? `Sprint ${f.automatedSince.split('-')[1]}` : '';
                            return `
                            <div class="flex items-center justify-between py-1 px-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                                <span class="flex items-center gap-2">
                                    <span class="text-gray-400">${isAutomated ? '✓' : '○'}</span>
                                    <span>${f.name}</span>
                                </span>
                                ${isAutomated 
                                    ? `<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">${sprintLabel}</span>`
                                    : '<span class="text-xs text-gray-400">В планах</span>'
                                }
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        }

        function updateDataSourcesList() {
            const container = document.getElementById('dataSourcesList');
            const filteredSources = DATA_SOURCES.filter(s => selectedDepts.has(s.department));
            const currentSprint = selectedSprintTo;
            
            // Group by department
            const byDept = {};
            filteredSources.forEach(s => {
                if (!byDept[s.department]) byDept[s.department] = [];
                byDept[s.department].push(s);
            });
            
            // Count totals
            let totalInWorkspace = 0;
            let totalSources = filteredSources.length;
            filteredSources.forEach(s => {
                if (s.inWorkspaceSince && s.inWorkspaceSince <= currentSprint) totalInWorkspace++;
            });
            
            // Update count in header
            document.getElementById('sourcesCount').textContent = `(${totalInWorkspace}/${totalSources})`;
            
            // Render tree
            const depts = Object.keys(byDept).sort();
            container.innerHTML = depts.map(dept => {
                const sources = byDept[dept];
                const deptInWorkspace = sources.filter(s => s.inWorkspaceSince && s.inWorkspaceSince <= currentSprint).length;
                const deptColor = DEPT_COLORS[dept] || '#9ca3af';
                
                return `
                <div class="mb-3">
                    <div class="flex items-center gap-2 py-1 px-2 rounded" style="background-color: ${deptColor}15">
                        <span class="w-3 h-3 rounded-full" style="background-color: ${deptColor}"></span>
                        <span class="font-medium" style="color: ${deptColor}">${getDeptName(dept)}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">(${deptInWorkspace}/${sources.length})</span>
                    </div>
                    <div class="ml-5 mt-1 space-y-1">
                        ${sources.map(s => {
                            const inWorkspace = s.inWorkspaceSince && s.inWorkspaceSince <= currentSprint;
                            const sprintLabel = s.inWorkspaceSince ? `Sprint ${s.inWorkspaceSince.split('-')[1]}` : '';
                            return `
                            <div class="flex items-center justify-between py-1 px-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                                <span class="flex items-center gap-2">
                                    <span class="text-gray-400">${inWorkspace ? '✓' : '○'}</span>
                                    <span>${s.name}</span>
                                </span>
                                ${inWorkspace 
                                    ? `<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">${sprintLabel}</span>`
                                    : '<span class="text-xs text-gray-400">В планах</span>'
                                }
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        }

        // ============================================
        // UPDATE FUNCTIONS
        // ============================================
        function updateSummaryCards() {
            const currentSprint = selectedSprintTo;
            
            // Total AI Roles - count from AI_ROLES array (single source of truth)
            const filteredRoles = AI_ROLES.filter(r => selectedDepts.has(r.department));
            const totalAiRoles = filteredRoles.filter(r => r.inProdSince && r.inProdSince <= currentSprint).length;
            
            // AI Functions - count from AI_FUNCTIONS array (single source of truth)
            const filteredFunctions = AI_FUNCTIONS.filter(f => selectedDepts.has(f.department));
            const totalFunctionsAutomated = filteredFunctions.filter(f => f.automatedSince && f.automatedSince <= currentSprint).length;
            const totalFunctionsAll = filteredFunctions.length;
            const functionsPercent = totalFunctionsAll > 0 ? totalFunctionsAutomated / totalFunctionsAll : 0;
            
            // Data Sources - count from DATA_SOURCES array (single source of truth)
            const filteredSources = DATA_SOURCES.filter(s => selectedDepts.has(s.department));
            const totalSourcesInWorkspace = filteredSources.filter(s => s.inWorkspaceSince && s.inWorkspaceSince <= currentSprint).length;
            const totalSourcesAll = filteredSources.length;
            const sourcesCoveragePercent = totalSourcesAll > 0 ? totalSourcesInWorkspace / totalSourcesAll : 0;

            document.getElementById('totalAiRoles').textContent = totalAiRoles;
            document.getElementById('totalAiFunctions').textContent = `${totalFunctionsAutomated}/${totalFunctionsAll} (${formatPercent(functionsPercent)})`;
            document.getElementById('dataSourcesCoverage').textContent = `${totalSourcesInWorkspace}/${totalSourcesAll} (${formatPercent(sourcesCoveragePercent)})`;
        }

        function updateDashboard() {
            updateSummaryCards();
            createAiRolesChart();
            createAiFunctionsChart();
            createDeptComparisonChart();
            createDataSourcesChart();
            updateRolesList();
            updateFunctionsList();
            updateDataSourcesList();
        }

        // ============================================
        // THEME FUNCTIONS
        // ============================================
        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }

        function getChartColors() {
            const dark = isDarkMode();
            return {
                textColor: dark ? '#e5e7eb' : '#374151',
                gridColor: dark ? '#374151' : '#e5e7eb',
                backgroundColor: dark ? '#1f2937' : '#ffffff'
            };
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            updateDashboard();
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initFilters();
            updateDashboard();
        });
    </script>
</body>
</html>
